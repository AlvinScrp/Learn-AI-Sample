<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物理世界中的小球碰撞</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .canvas-container {
            position: relative;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
        }

        #gameCanvas {
            display: block;
            background: rgba(0, 0, 0, 0.1);
        }

        .info {
            margin-top: 15px;
            color: white;
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏀 物理世界中的小球碰撞</h1>
        
        <div class="controls">
            <button onclick="startAnimation()">开始运动</button>
            <button onclick="pauseAnimation()">暂停</button>
            <button onclick="resetAnimation()">重置</button>
            <button onclick="changeSpeed()">改变速度</button>
        </div>

        <div class="canvas-container">
            <canvas id="gameCanvas" width="600" height="400"></canvas>
        </div>

        <div class="info">
            <p>红色小球在三角形区域内运动，碰到边界会自动反弹</p>
            <div class="stats">
                <div class="stat">碰撞次数: <span id="collisionCount">0</span></div>
                <div class="stat">运动时间: <span id="elapsedTime">0</span>秒</div>
                <div class="stat">当前速度: <span id="currentSpeed">5</span>px/s</div>
            </div>
        </div>
    </div>

    <script>
        // 获取画布和上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 小球属性
        const ball = {
            x: 300,
            y: 200,
            radius: 15,
            dx: 3,
            dy: 2,
            speed: 5,
            color: '#ff4757'
        };

        // 三角形边界点
        const triangle = [
            { x: 50, y: 350 },   // 左下角
            { x: 550, y: 350 },  // 右下角
            { x: 300, y: 50 }    // 顶部
        ];

        // 动画状态
        let animationId = null;
        let isRunning = false;
        let startTime = Date.now();
        let collisionCount = 0;

        // 更新统计信息
        function updateStats() {
            document.getElementById('collisionCount').textContent = collisionCount;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('elapsedTime').textContent = elapsed;
            document.getElementById('currentSpeed').textContent = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy).toFixed(1);
        }

        // 检查点是否在三角形内
        function isPointInTriangle(px, py) {
            const [p1, p2, p3] = triangle;
            
            // 使用重心坐标法判断点是否在三角形内
            const denominator = ((p2.y - p3.y) * (p1.x - p3.x) + (p3.x - p2.x) * (p1.y - p3.y));
            const a = ((p2.y - p3.y) * (px - p3.x) + (p3.x - p2.x) * (py - p3.y)) / denominator;
            const b = ((p3.y - p1.y) * (px - p3.x) + (p1.x - p3.x) * (py - p3.y)) / denominator;
            const c = 1 - a - b;
            
            return a >= 0 && b >= 0 && c >= 0;
        }

        // 计算点到线段的距离
        function distanceToLineSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            
            if (lenSq === 0) return Math.sqrt(A * A + B * B);
            
            let param = dot / lenSq;
            param = Math.max(0, Math.min(1, param));
            
            const xx = x1 + param * C;
            const yy = y1 + param * D;
            
            const dx = px - xx;
            const dy = py - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }

        // 检查与三角形边界的碰撞
        function checkTriangleCollision() {
            const [p1, p2, p3] = triangle;
            const ballCenter = { x: ball.x, y: ball.y };
            
            // 检查与三条边的碰撞
            const edges = [
                [p1, p2], // 底边
                [p2, p3], // 右边
                [p3, p1]  // 左边
            ];
            
            for (let edge of edges) {
                const [start, end] = edge;
                const distance = distanceToLineSegment(ball.x, ball.y, start.x, start.y, end.x, end.y);
                
                if (distance <= ball.radius) {
                    // 计算反弹方向
                    const edgeVector = {
                        x: end.x - start.x,
                        y: end.y - start.y
                    };
                    
                    // 计算法向量（垂直于边）
                    const normal = {
                        x: -edgeVector.y,
                        y: edgeVector.x
                    };
                    
                    // 归一化法向量
                    const length = Math.sqrt(normal.x * normal.x + normal.y * normal.y);
                    normal.x /= length;
                    normal.y /= length;
                    
                    // 计算速度在法向量上的投影
                    const dotProduct = ball.dx * normal.x + ball.dy * normal.y;
                    
                    // 反弹：速度减去法向量投影的两倍
                    ball.dx -= 2 * dotProduct * normal.x;
                    ball.dy -= 2 * dotProduct * normal.y;
                    
                    collisionCount++;
                    return true;
                }
            }
            
            return false;
        }

        // 更新小球位置
        function updateBall() {
            // 更新位置
            ball.x += ball.dx;
            ball.y += ball.dy;
            
            // 检查碰撞
            checkTriangleCollision();
            
            // 确保小球不会完全离开三角形区域
            if (!isPointInTriangle(ball.x, ball.y)) {
                // 如果小球离开三角形，将其拉回中心
                ball.x = 300;
                ball.y = 200;
            }
        }

        // 绘制三角形
        function drawTriangle() {
            ctx.beginPath();
            ctx.moveTo(triangle[0].x, triangle[0].y);
            ctx.lineTo(triangle[1].x, triangle[1].y);
            ctx.lineTo(triangle[2].x, triangle[2].y);
            ctx.closePath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // 绘制半透明填充
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fill();
        }

        // 绘制小球
        function drawBall() {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            
            // 添加高光效果
            ctx.beginPath();
            ctx.arc(ball.x - 5, ball.y - 5, 5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fill();
        }

        // 绘制速度向量
        function drawVelocityVector() {
            const scale = 3;
            ctx.beginPath();
            ctx.moveTo(ball.x, ball.y);
            ctx.lineTo(ball.x + ball.dx * scale, ball.y + ball.dy * scale);
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.8)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制箭头
            const angle = Math.atan2(ball.dy, ball.dx);
            const arrowLength = 10;
            const arrowX = ball.x + ball.dx * scale;
            const arrowY = ball.y + ball.dy * scale;
            
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(arrowX - arrowLength * Math.cos(angle - Math.PI/6), 
                      arrowY - arrowLength * Math.sin(angle - Math.PI/6));
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(arrowX - arrowLength * Math.cos(angle + Math.PI/6), 
                      arrowY - arrowLength * Math.sin(angle + Math.PI/6));
            ctx.stroke();
        }

        // 动画循环
        function animate() {
            if (!isRunning) return;
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制三角形
            drawTriangle();
            
            // 更新小球位置
            updateBall();
            
            // 绘制小球
            drawBall();
            
            // 绘制速度向量
            drawVelocityVector();
            
            // 更新统计信息
            updateStats();
            
            // 继续动画
            animationId = requestAnimationFrame(animate);
        }

        // 开始动画
        function startAnimation() {
            if (!isRunning) {
                isRunning = true;
                startTime = Date.now();
                animate();
            }
        }

        // 暂停动画
        function pauseAnimation() {
            isRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        // 重置动画
        function resetAnimation() {
            pauseAnimation();
            ball.x = 300;
            ball.y = 200;
            ball.dx = 3;
            ball.dy = 2;
            collisionCount = 0;
            startTime = Date.now();
            updateStats();
            
            // 重绘静态画面
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawTriangle();
            drawBall();
            drawVelocityVector();
        }

        // 改变速度
        function changeSpeed() {
            const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
            const newSpeed = speed * 1.5;
            const ratio = newSpeed / speed;
            
            ball.dx *= ratio;
            ball.dy *= ratio;
        }

        // 初始化
        function init() {
            resetAnimation();
            
            // 添加键盘控制
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        if (isRunning) {
                            pauseAnimation();
                        } else {
                            startAnimation();
                        }
                        break;
                    case 'r':
                    case 'R':
                        resetAnimation();
                        break;
                    case 's':
                    case 'S':
                        changeSpeed();
                        break;
                }
            });
        }

        // 启动应用
        init();
    </script>
</body>
</html>
